/*
 *     Filename:  main.c
 *         Mail:  tn.razy@gmail.com
 *
 *  Description:  
 *
 */

#define ___DEBUG

#include "ui.h"
#include "mpd.h"
#include "msg.h"
#include "coverfetch.h"

#include <string.h>
#include <unistd.h>

int main(int argc, char **argv)
{
    	/* init seeting */

	skin_load();
	struct mpd_status *status, *last_status = NULL;
	struct mpd_entity *entity, *last_entity = NULL;
	const struct mpd_song *song, *last_song = NULL;

	if(mpd_currentstaus(&status, &entity) < 0)
	{
		_ERROR("Get mpd infomation error.");
		/* set gui idle */
	}

	while(1)
	{
		if(mpd_currentstaus(&status, &entity) < 0)
		{
			_ERROR("Get mpd information error.");
			/* set gui idle */
			_DEBUG("GUI idle.");
		}

		song = mpd_entity_get_song(entity);

		if(last_status == NULL)
		{
			last_status = status;
			last_entity = entity;
			last_song = song;

			/* init gui, laod cover */

			getcover(   mpd_song_uri(song), 
			  		mpd_song_artist(song), 
			  		mpd_song_title(song), 
			  		mpd_song_album(song),
			  		doubancover);
			_DEBUG("init, Load cover.");
		}
		else if(mpd_song_pos(song) != mpd_song_pos(last_song))
		{
			mpd_status_free(last_status);
			mpd_entity_free(last_entity);

			last_status = status;
			last_entity = entity;
			last_song = song;
			/* load cover */

			getcover(   mpd_song_uri(song), 
			  		mpd_song_artist(song), 
			  		mpd_song_title(song), 
			  		mpd_song_album(song),
			  		doubancover);
			_DEBUG("Load cover.");
		}

		sleep(1);
	}

	return 0;
}
